name: Workflow Manager & Maintenance (System Admin)

# ë§¤ì¼ ìžì •(00:00 KST)ì— ìžë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ì‹œìŠ¤í…œì„ ì ê²€í•©ë‹ˆë‹¤.
on:
  schedule:
    - cron: '0 15 * * *' # UTC 15:00 = KST 00:00 (í•œêµ­ ì‹œê°„ ìžì •)
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  actions: write # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë° ì‚­ì œ ê¶Œí•œ
  contents: write # ì €ìž¥ì†Œ í™œë™ ì‹ í˜¸(Keep-alive) ìƒì„±ì„ ìœ„í•œ ê¶Œí•œ

jobs:
  system-maintenance:
    runs-on: ubuntu-latest
    
    steps:
      # ----------------------------------------------------------------
      # 1. í™˜ê²½ ì„¤ì •
      # ----------------------------------------------------------------
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # 2. [ì²­ì†Œ] ì €ìž¥ì†Œ ìš©ëŸ‰ í™•ë³´ (ì˜¤ëž˜ëœ ì˜ìƒ/ë¡œê·¸ ì‚­ì œ)
      # ----------------------------------------------------------------
      - name: ðŸ§¹ Delete Old Workflow Runs & Artifacts
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 3        # 3ì¼ ì§€ë‚œ ê¸°ë¡ì€ ì‚­ì œ
          keep_minimum_runs: 5  # ìµœì†Œ ìµœê·¼ 5ê°œëŠ” ë‚¨ê¹€
          delete_run_by_conclusion_pattern: "cancelled, skipped, success" # ì‹¤íŒ¨í•œ ê±´ ë¶„ì„ì„ ìœ„í•´ ë‚¨ê¸¸ ìˆ˜ë„ ìžˆìŒ (ì—¬ê¸°ì„  ì„±ê³µí•œ ê²ƒ ìœ„ì£¼ ì‚­ì œ)

      - name: ðŸ“ Log Cleanup Status
        run: |
          echo "=========================================="
          echo "ðŸ§¹ [System] ì €ìž¥ì†Œ ì²­ì†Œ ì™„ë£Œ"
          echo "=========================================="
          echo "ì˜¤ëž˜ëœ ì‹¤í–‰ ê¸°ë¡(Runs)ê³¼ ì•„í‹°íŒ©íŠ¸(Artifacts)ë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤."
          echo "í™•ë³´ëœ ê³µê°„ì€ ìƒˆë¡œìš´ ì˜ìƒ ì œìž‘ì— ì‚¬ìš©ë©ë‹ˆë‹¤."

      # ----------------------------------------------------------------
      # 3. [ìƒì¡´ì‹ í˜¸] ì›Œí¬í”Œë¡œìš° ë¹„í™œì„±í™” ë°©ì§€ (Keep-alive)
      # ----------------------------------------------------------------
      - name: â¤ï¸ Keep-alive (Prevent GitHub Suspension)
        uses: gautamkrishnar/keepalive-workflow@v1
        with:
          # 60ì¼ê°„ ì»¤ë°‹ì´ ì—†ìœ¼ë©´ Cronì´ ë©ˆì¶”ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë”ë¯¸ ì»¤ë°‹ ìƒì„±
          commit_message: "ðŸ¤– [Maintenance] Workflow Keep-alive ping"
          committer_username: "Workflow-Manager-Bot"
          committer_email: "manager@bot.com"

      - name: ðŸ“ Log Keep-alive Status
        run: |
          echo "=========================================="
          echo "â¤ï¸ [System] ìƒì¡´ ì‹ í˜¸(Keep-alive) ì „ì†¡ ì™„ë£Œ"
          echo "=========================================="
          echo "GitHubì˜ 60ì¼ ë¹„í™œì„±í™” ì •ì±…ì„ ìš°íšŒí•˜ì—¬ ìƒì‹œ ê°€ë™ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤."

      # ----------------------------------------------------------------
      # 4. [íŠ¸ë¦¬ê±°] ë©”ì¸ ì˜ìƒ ì œìž‘ ì›Œí¬í”Œë¡œìš° ê°•ì œ ê°€ë™
      # ----------------------------------------------------------------
      - name: ðŸš€ Trigger Main Video Ops
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=========================================="
          echo "ðŸš€ [Manager] ë©”ì¸ ì›Œí¬í”Œë¡œìš° ê°€ë™ ì§€ì‹œ"
          echo "=========================================="
          
          # ë©”ì¸ ì›Œí¬í”Œë¡œìš° íŒŒì¼ëª… (secure_video_ops.yml)ì„ ì§€ì •í•˜ì—¬ ì‹¤í–‰
          # íŒŒì¼ëª…ì´ ë‹¤ë¥¼ ê²½ìš° ì•„ëž˜ 'secure_video_ops.yml'ì„ ì‹¤ì œ íŒŒì¼ëª…ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
          WORKFLOW_FILE="secure_video_ops.yml"
          
          echo "ëŒ€ìƒ: $WORKFLOW_FILE"
          
          # ì‹¤í–‰ ëª…ë ¹ (gh cli ì‚¬ìš©)
          if gh workflow run $WORKFLOW_FILE --ref main; then
            echo "âœ… ë©”ì¸ ì›Œí¬í”Œë¡œìš°($WORKFLOW_FILE)ê°€ ì„±ê³µì ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹¤íŒ¨. íŒŒì¼ëª…ì„ í™•ì¸í•˜ê±°ë‚˜ ê¶Œí•œì„ ì ê²€í•˜ì„¸ìš”."
            # ì‹¤íŒ¨ ì‹œì—ë„ ë§¤ë‹ˆì €ëŠ” ì£½ì§€ ì•Šë„ë¡ exit code 0 ì²˜ë¦¬ (ì„ íƒì‚¬í•­)
            exit 1
          fi

      # ----------------------------------------------------------------
      # 5. [ë³´ê³ ] ê´€ë¦¬ ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„±
      # ----------------------------------------------------------------
      - name: ðŸ“Š Generate Maintenance Report
        if: always()
        run: |
          echo "## ðŸ‘®â€â™‚ï¸ Workflow Manager Report" >> $GITHUB_STEP_SUMMARY
          echo "ê´€ë¦¬ìž ë´‡ì´ ì‹œìŠ¤í…œ ìœ ì§€ë³´ìˆ˜ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cleanup** | âœ… Done | Retain 3 days, Min 5 runs |" >> $GITHUB_STEP_SUMMARY
          echo "| **Keep-alive** | âœ… Active | Prevented suspension |" >> $GITHUB_STEP_SUMMARY
          echo "| **Main Trigger** | ðŸš€ Fired | Started \`secure_video_ops.yml\` |" >> $GITHUB_STEP_SUMMARY
