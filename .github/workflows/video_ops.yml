name: Fixed Video Ops (ImageMagick Policy Unlocked)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  video-production-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ----------------------------------------------------------------
      # 1. í™˜ê²½ ì„¤ì •
      # ----------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ----------------------------------------------------------------
      # 2. ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° [í•µì‹¬] ë³´ì•ˆ ì •ì±… í•´ì œ
      # ----------------------------------------------------------------
      - name: ğŸ› ï¸ Install System Dependencies & Unlock Security Policy
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 1] ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ë° ë³´ì•ˆ ì„¤ì •"
          echo "=========================================="
          
          # íŒ¨í‚¤ì§€ ì €ì¥ì†Œ ì¶”ê°€ ë° ì„¤ì¹˜
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick espeak-ng libsm6 libxext6 ghostscript fonts-nanum
          
          echo "ğŸ”§ [Critical Fix] ImageMagick ë³´ì•ˆ ì •ì±… ê°•ì œ í•´ì œ ì¤‘..."
          
          # 1. PDF ê¶Œí•œ í—ˆìš©
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml
          
          # 2. [ì—ëŸ¬ ì›ì¸ í•´ê²°] @* íŒ¨í„´ (í…ìŠ¤íŠ¸ íŒŒì¼ ì°¸ì¡°) ê¶Œí•œ í—ˆìš©
          # ì´ ë¶€ë¶„ì´ ë§‰í˜€ ìˆì–´ì„œ 'attempt to perform...' ì—ëŸ¬ê°€ ë°œìƒí•œ ê²ƒì„
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml
          
          # 3. ëª¨ë“  path ê¶Œí•œ í—ˆìš© (í˜¹ì‹œ ëª¨ë¥¼ ì¶”ê°€ ì—ëŸ¬ ë°©ì§€)
          sudo sed -i 's/<policy domain="path" rights="none" pattern="@\*" \/>//' /etc/ImageMagick-6/policy.xml || true
          
          # ì •ì±… ë³€ê²½ í™•ì¸ (ë¡œê·¸ ì¶œë ¥)
          echo "ğŸ” ë³€ê²½ëœ ì •ì±… í™•ì¸:"
          cat /etc/ImageMagick-6/policy.xml | grep "pattern=\"@*\"" || echo "Pattern @* not found (might be good)"
          
          echo "âœ… ì‹œìŠ¤í…œ ë³´ì•ˆ ì„¤ì • ì™„ë£Œ"

      # ----------------------------------------------------------------
      # 3. íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      # ----------------------------------------------------------------
      - name: ğŸ“¦ Install Python Libraries
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 2] íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜"
          echo "=========================================="
          
          python -m pip install --upgrade pip
          
          # MoviePy 1.0.3 ë²„ì „ê³¼ Pillow í˜¸í™˜ì„± ìœ ì§€ (ì¤‘ìš”)
          pip install moviepy==1.0.3 opencv-python-headless numpy pandas gTTS pydub mediapipe requests pillow==9.5.0
          
          echo "âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì™„ë£Œ"

      # ----------------------------------------------------------------
      # 4. ì˜ìƒ ì œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # ----------------------------------------------------------------
      - name: ğŸ¬ Run Video Generation Script
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 3] ì˜ìƒ ì œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
          echo "=========================================="
          
          mkdir -p scripts
          cd scripts
          
          # ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (Here-Doc ë¬¸ë²• ì¤€ìˆ˜)
          cat <<EOF > main.py
          import os
          import sys
          
          # [í•µì‹¬ ì„¤ì •] MoviePyê°€ ImageMagickì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ëª…ì‹œ
          from moviepy.config import change_settings
          change_settings({"IMAGEMAGICK_BINARY": "/usr/bin/convert"})
          
          from moviepy.editor import ColorClip, TextClip, CompositeVideoClip, AudioFileClip
          from gtts import gTTS
          
          def make_video():
              try:
                  print("â–¶ï¸ [Python] ì˜ìƒ ì œì‘ ë¡œì§ ì‹œì‘...")
                  output_file = "final_output.mp4"
                  
                  # 1. ìŒì„± ìƒì„±
                  print("   - (1/4) ìŒì„± í•©ì„±(TTS) ì¤‘...")
                  text_script = "ImageMagick ë³´ì•ˆ ì •ì±…ì´ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ìƒ ì œì‘ ì„±ê³µ!"
                  tts = gTTS(text=text_script, lang='ko')
                  tts.save("voice.mp3")
                  
                  # 2. ì˜¤ë””ì˜¤ ë¡œë“œ
                  audio_clip = AudioFileClip("voice.mp3")
                  duration = audio_clip.duration + 2.0
                  
                  # 3. ìë§‰ ìƒì„± (ì—ëŸ¬ê°€ ë°œìƒí–ˆë˜ êµ¬ê°„)
                  print("   - (2/4) ìë§‰ ë Œë”ë§ ì¤‘ (ImageMagick)...")
                  
                  # í°íŠ¸ í™•ì¸
                  font_path = '/usr/share/fonts/truetype/nanum/NanumGothic.ttf'
                  if not os.path.exists(font_path):
                      font_path = 'DejaVuSans' # fallback
                      
                  # ë°°ê²½
                  bg_clip = ColorClip(size=(1280, 720), color=(0, 70, 0), duration=duration)
                  
                  # ìë§‰ (TextClip ìƒì„± ì‹œ ImageMagick convert í˜¸ì¶œë¨)
                  # method='caption'ì€ ìë™ ì¤„ë°”ê¿ˆ ì§€ì›
                  txt_clip = TextClip(
                      text_script, 
                      fontsize=50, 
                      color='white', 
                      font=font_path, 
                      size=(1000, None), 
                      method='caption'
                  )
                  txt_clip = txt_clip.set_position('center').set_duration(duration)
                  
                  # 4. í•©ì„± ë° ì €ì¥
                  print("   - (3/4) ì˜ìƒ í•©ì„± ë° ì¸ì½”ë”©...")
                  final_video = CompositeVideoClip([bg_clip, txt_clip]).set_audio(audio_clip)
                  
                  # logger=Noneìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë¶ˆí•„ìš”í•œ ffmpeg ë¡œê·¸ ìˆ¨ê¹€
                  final_video.write_videofile(
                      output_file, 
                      fps=24, 
                      codec='libx264', 
                      audio_codec='aac',
                      logger=None
                  )
                  
                  if os.path.exists(output_file):
                      print(f"âœ… [Success] (4/4) íŒŒì¼ ìƒì„± ì™„ë£Œ: {output_file}")
                  else:
                      print("âŒ [Error] íŒŒì¼ ìƒì„± ì‹¤íŒ¨")
                      sys.exit(1)
                      
              except Exception as e:
                  print(f"âŒ [Critical Error] : {e}")
                  # ì—ëŸ¬ ìƒì„¸ ë‚´ìš©ì„ ë³´ê¸° ìœ„í•´ traceback ì¶œë ¥ ê¶Œì¥
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)
          
          if __name__ == "__main__":
              make_video()
          EOF
          
          echo "â–¶ï¸ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘..."
          python main.py
          
          echo "ğŸ” ê²°ê³¼ íŒŒì¼ í™•ì¸:"
          ls -lh *.mp4

      # ----------------------------------------------------------------
      # 5. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      # ----------------------------------------------------------------
      - name: ğŸ’¾ Commit and Push Generated Videos
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 4] Git ì €ì¥ì†Œ ì—…ë¡œë“œ"
          echo "=========================================="
          
          git config --global user.name "Video-Bot"
          git config --global user.email "bot@video-server.com"
          
          # ê°•ì œë¡œ ì¶”ê°€ (-f)
          git add -f scripts/*.mp4
          
          if git diff --staged --quiet; then
            echo "âš ï¸ [Warning] ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          else
            git commit -m "ğŸ¥ Fixed Video Generated [skip ci]"
            git push
            echo "âœ… ì˜ìƒ ì—…ë¡œë“œ ì™„ë£Œ!"
          fi
