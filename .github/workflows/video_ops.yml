name: Fixed Video Production Workflow

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  video-production-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ----------------------------------------------------------------
      # 1. í™˜ê²½ ì„¤ì •
      # ----------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ----------------------------------------------------------------
      # 2. ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ë¡œê·¸ í¬í•¨)
      # ----------------------------------------------------------------
      - name: ğŸ› ï¸ Install System Dependencies
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 1] ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ì„¤ì •"
          echo "=========================================="
          
          # íŒ¨í‚¤ì§€ ì €ì¥ì†Œ ì¶”ê°€ ë° ì„¤ì¹˜
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick espeak-ng libsm6 libxext6 ghostscript fonts-nanum
          
          # ImageMagick ì •ì±… ìˆ˜ì • (í•œ ì¤„ë¡œ ëª…í™•í•˜ê²Œ ì²˜ë¦¬)
          echo "ğŸ”§ ImageMagick ì •ì±… ë³´ì•ˆ ì™„í™” ì¤‘..."
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml || true
          
          echo "âœ… ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

      # ----------------------------------------------------------------
      # 3. íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      # ----------------------------------------------------------------
      - name: ğŸ“¦ Install Python Libraries
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 2] íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜"
          echo "=========================================="
          
          python -m pip install --upgrade pip
          
          # í˜¸í™˜ì„±ì´ ê²€ì¦ëœ ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜
          pip install moviepy==1.0.3 opencv-python-headless numpy pandas gTTS pydub mediapipe requests pillow==9.5.0
          
          echo "âœ… íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì™„ë£Œ"

      # ----------------------------------------------------------------
      # 4. ì˜ìƒ ì œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰ (ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •ë¨)
      # ----------------------------------------------------------------
      - name: ğŸ¬ Run Video Generation Script
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 3] ì˜ìƒ ì œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰"
          echo "=========================================="
          
          mkdir -p scripts
          cd scripts
          
          # [ìˆ˜ì •ë¨] EOF ë¬¸ë²• ì˜¤ë¥˜ í•´ê²°: ì¤„ë°”ê¿ˆì„ ëª…í™•í•˜ê²Œ ë¶„ë¦¬í•¨
          cat <<EOF > main.py
          import os
          import sys
          # MoviePy ì„¤ì •
          from moviepy.config import change_settings
          change_settings({"IMAGEMAGICK_BINARY": "/usr/bin/convert"})
          
          from moviepy.editor import ColorClip, TextClip, CompositeVideoClip, AudioFileClip
          from gtts import gTTS
          
          def make_video():
              try:
                  print("â–¶ï¸ ì˜ìƒ ì œì‘ ë¡œì§ ì‹œì‘...")
                  output_file = "hq_video_output.mp4"
                  
                  # 1. ìŒì„±(TTS) ìƒì„±
                  print("   - ìŒì„± í•©ì„± ì¤‘...")
                  text_script = "GitHub Actions ì˜ìƒ ì„œë²„ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
                  tts = gTTS(text=text_script, lang='ko')
                  tts.save("voice.mp3")
                  
                  # 2. ì˜¤ë””ì˜¤ ë¡œë“œ
                  audio_clip = AudioFileClip("voice.mp3")
                  duration = audio_clip.duration + 2.0
                  
                  # 3. í°íŠ¸ ì„¤ì • (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
                  font_path = '/usr/share/fonts/truetype/nanum/NanumGothic.ttf'
                  if not os.path.exists(font_path):
                      font_path = 'DejaVuSans'
                  
                  # 4. ì˜ìƒ êµ¬ì„±
                  bg_clip = ColorClip(size=(1280, 720), color=(0, 0, 100), duration=duration)
                  txt_clip = TextClip(text_script, fontsize=40, color='white', font=font_path, size=(1100, None), method='caption')
                  txt_clip = txt_clip.set_position('center').set_duration(duration)
                  
                  # 5. í•©ì„± ë° ì €ì¥
                  final_video = CompositeVideoClip([bg_clip, txt_clip]).set_audio(audio_clip)
                  final_video.write_videofile(output_file, fps=24, codec='libx264', audio_codec='aac', logger=None)
                  
                  if os.path.exists(output_file):
                      print(f"âœ… íŒŒì¼ ìƒì„± ì„±ê³µ: {output_file}")
                  else:
                      print("âŒ íŒŒì¼ ìƒì„± ì‹¤íŒ¨")
                      sys.exit(1)
                      
              except Exception as e:
                  print(f"âŒ ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ: {e}")
                  sys.exit(1)
          
          if __name__ == "__main__":
              make_video()
          EOF
          
          # ë„ì–´ì“°ê¸° ë¬¸ì œ ì—†ì´ íŒŒì¼ì´ ì˜ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ì‹¤í–‰
          echo "ğŸ“„ main.py ìƒì„± í™•ì¸..."
          ls -l main.py
          
          echo "â–¶ï¸ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
          python main.py

      # ----------------------------------------------------------------
      # 5. ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ì˜¤ë¥˜ ë°©ì§€ ë¡œì§ í¬í•¨)
      # ----------------------------------------------------------------
      - name: ğŸ’¾ Commit and Push Generated Videos
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 4] ê²°ê³¼ë¬¼ Git ì €ì¥ì†Œ ì—…ë¡œë“œ"
          echo "=========================================="
          
          git config --global user.name "Video-Bot"
          git config --global user.email "bot@video-server.com"
          
          echo "ğŸ“¦ MP4 íŒŒì¼ ìŠ¤í…Œì´ì§•..."
          # ê°•ì œë¡œ ì¶”ê°€ (-f) í•˜ì—¬ gitignore ë¬´ì‹œ
          git add -f scripts/*.mp4
          
          if git diff --staged --quiet; then
            echo "âš ï¸ [Warning] ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ í™•ì¸ í•„ìš”)"
            # íŒŒì¼ì„ ëª» ë§Œë“¤ì—ˆìœ¼ë©´ ì—ëŸ¬ë¡œ ì²˜ë¦¬í•˜ì—¬ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨
            exit 1
          else
            git commit -m "ğŸ¥ High-Quality Video Generated [skip ci]"
            git push
            echo "âœ… ì˜ìƒ ì—…ë¡œë“œ ì™„ë£Œ!"
          fi
