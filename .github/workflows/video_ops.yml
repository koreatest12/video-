name: Full Video Production Server (Fixed & Enhanced)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  video-production-server:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # 2. íŒŒì´ì¬ 3.11 í™˜ê²½ ì„¤ì •
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. [ìˆ˜ì •ë¨] ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ (ì—ëŸ¬ í•´ê²° ë° ê°•í™”)
      - name: ğŸ› ï¸ Install System Dependencies
        run: |
          # (ì¤‘ìš”) Universe ì €ì¥ì†Œ ì¶”ê°€ (ëŒ€ë¶€ë¶„ì˜ ë¯¸ë””ì–´ íŒ¨í‚¤ì§€ê°€ ì—¬ê¸°ì— ìˆìŒ)
          sudo add-apt-repository universe
          sudo apt-get update
          
          # íŒ¨í‚¤ì§€ ì„¤ì¹˜ ëª©ë¡ ìµœì‹ í™”
          # espeak-ng: ìŒì„± í•©ì„± (ì´ë¦„ ë³€ê²½ë¨)
          # fonts-nanum: ì˜ìƒ ìë§‰ìš© í•œê¸€ í°íŠ¸ (ì¶”ê°€ë¨)
          sudo apt-get install -y ffmpeg imagemagick espeak-ng libsm6 libxext6 ghostscript fonts-nanum

          # ImageMagick ì •ì±… ì™„í™” (ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ìŠ¤í¬ë¦½íŠ¸ê°€ ë©ˆì¶”ì§€ ì•Šë„ë¡ '|| true' ì¶”ê°€)
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml || true
          
          echo "âœ… ì‹œìŠ¤í…œ ë° ì˜ìƒ/ìŒì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

      # 4. íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: ğŸ“¦ Install Python Libraries
        run: |
          python -m pip install --upgrade pip
          
          # requirements.txt íŒŒì¼ì´ ìˆìœ¼ë©´ ì„¤ì¹˜
          if [ -f ./scripts/requirements.txt ]; then pip install -r ./scripts/requirements.txt; fi
          
          # í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°•ì œ ì¬ì„¤ì¹˜ ë° ì—…ê·¸ë ˆì´ë“œ
          # pillow: ì´ë¯¸ì§€ ì²˜ë¦¬ ìµœì‹ í™”
          pip install --upgrade moviepy opencv-python-headless numpy pandas gTTS pydub mediapipe requests pillow

      # 5. ì˜ìƒ ì œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: ğŸ¬ Run Video Generation Script
        run: |
          echo "ğŸš€ ì˜ìƒ ì œì‘ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
          
          # scripts í´ë” ì¡´ì¬ í™•ì¸ ë° ì´ë™
          if [ -d "./scripts" ]; then cd scripts; fi
          
          # (ì‹¤ì œ ìš´ì˜ ì‹œ ì£¼ì„ í•´ì œ)
          # python main.py
          
          # í…ŒìŠ¤íŠ¸ìš©: ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì„ ê²½ìš° ë”ë¯¸ íŒŒì¼ ìƒì„± (ì—ëŸ¬ ë°©ì§€)
          if [ ! -f "main.py" ]; then
            echo "âš ï¸ main.pyê°€ ì—†ì–´ í…ŒìŠ¤íŠ¸ìš© ì˜ìƒ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤."
            # 1ì´ˆì§œë¦¬ ë¹ˆ mp4 íŒŒì¼ ìƒì„± (ffmpeg í™œìš©)
            ffmpeg -f lavfi -i color=c=blue:s=1280x720:d=1 -c:v libx264 -pix_fmt yuv420p output_test.mp4
          fi

      # 6. ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë‹¤ìš´ë¡œë“œìš©)
      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: finished-videos
          path: |
            scripts/*.mp4
            scripts/*.mp3
            *.mp4

      # 7. Git ì €ì¥ì†Œì— ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (Push)
      - name: ğŸ’¾ Commit and Push Generated Videos
        run: |
          git config --global user.name "Video-Bot"
          git config --global user.email "bot@video-server.com"
          
          # ìƒì„±ëœ ëª¨ë“  MP4 íŒŒì¼ ì¶”ê°€
          git add *.mp4 scripts/*.mp4 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "âš ï¸ ì—…ë¡œë“œí•  ìƒˆë¡œìš´ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸ¥ Auto-generated video [skip ci]"
            git push
            echo "âœ… ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ"
          fi
