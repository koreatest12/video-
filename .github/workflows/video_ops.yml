name: Full Video Production Server (AI + TTS + Auto-Upload)

on:
  workflow_dispatch:      # ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë²„íŠ¼ ëˆŒëŸ¬ ì‹¤í–‰
  push:
    branches: [ "main" ]  # ë©”ì¸ ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì‹¤í–‰

jobs:
  video-production-server:
    runs-on: ubuntu-latest
    # ì¤‘ìš”: ìƒì„±ëœ ì˜ìƒ íŒŒì¼ì„ ì €ì¥ì†Œì— ì“°ê¸°(Push) ìœ„í•œ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: write

    steps:
      # ----------------------------------------------------------------
      # 1. [í™˜ê²½ ì¤€ë¹„] ì†ŒìŠ¤ ì½”ë“œ ë° íŒŒì´ì¬ ì„¤ì •
      # ----------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ----------------------------------------------------------------
      # 2. [ì˜ìƒ ì„œë²„ ì„¤ì¹˜] ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ëŒ€ëŸ‰ ì„¤ì¹˜ (ì—…ê·¸ë ˆì´ë“œ ë°˜ì˜)
      # ----------------------------------------------------------------
      - name: ğŸ› ï¸ Install System Dependencies (Video/Audio/Graphics)
        run: |
          sudo apt-get update
          
          # 1. FFmpeg: ì˜ìƒ ì¸ì½”ë”©/ë””ì½”ë”© í•µì‹¬ ì—”ì§„
          # 2. ImageMagick: ìë§‰, ì¸ë„¤ì¼, ê·¸ë˜í”½ ì²˜ë¦¬
          # 3. Libespeak-ng: ì˜¤ë””ì˜¤ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
          sudo apt-get install -y ffmpeg imagemagick libespeak-ng libsm6 libxext6 ghostscript

          # ImageMagick ì •ì±… ë³´ì•ˆ ì™„í™” (ìë§‰ ì²˜ë¦¬ë¥¼ ìœ„í•´ í•„ìˆ˜)
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml
          
          echo "âœ… ì˜ìƒ ì„œë²„ ì‹œìŠ¤í…œ êµ¬ì¶• ì™„ë£Œ (FFmpeg, ImageMagick, Audio installed)"

      # ----------------------------------------------------------------
      # 3. [ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜] íŒŒì´ì¬ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (AI + TTS ë°˜ì˜)
      # ----------------------------------------------------------------
      - name: ğŸ“¦ Install Python Libraries (AI & TTS Support)
        run: |
          python -m pip install --upgrade pip
          
          # ê¸°ì¡´ requirements.txtê°€ ìˆë‹¤ë©´ ìš°ì„  ì„¤ì¹˜
          if [ -f ./scripts/requirements.txt ]; then pip install -r ./scripts/requirements.txt; fi
          
          # [í•µì‹¬] ëŒ€ëŸ‰ ê¸°ëŠ¥ ì¶”ê°€ë¥¼ ìœ„í•œ ê°•ì œ ì„¤ì¹˜ ëª…ë ¹
          # moviepy: ì˜ìƒ í¸ì§‘
          # gTTS, pydub: ìŒì„± í•©ì„± ë° ì˜¤ë””ì˜¤ ì²˜ë¦¬
          # mediapipe: AI ì–¼êµ´/ëª¨ì…˜ ì¸ì‹
          # opencv: ì´ë¯¸ì§€ ì²˜ë¦¬
          pip install moviepy opencv-python-headless numpy pandas gTTS pydub mediapipe requests
          
          echo "âœ… íŒŒì´ì¬ AI/ë¯¸ë””ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì™„ë£Œ"

      # ----------------------------------------------------------------
      # 4. [ì˜ìƒ ì œì‘] ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ë©”ì¸ í”„ë¡œì„¸ìŠ¤)
      # ----------------------------------------------------------------
      - name: ğŸ¬ Run Video Generation Script
        run: |
          echo "ğŸš€ ì˜ìƒ ì œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
          
          # scripts í´ë”ê°€ ìˆë‹¤ë©´ ì´ë™
          if [ -d "./scripts" ]; then cd scripts; fi
          
          # ì‹¤ì œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (íŒŒì¼ëª…ì´ main.pyë¼ê³  ê°€ì •)
          # python main.py
          
          # [í…ŒìŠ¤íŠ¸ìš©] ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì„ ë•Œ ì—ëŸ¬ ë°©ì§€ìš© (ì‚­ì œ ê°€ëŠ¥)
          # ì‹¤ì œ ì‘ë™ ì‹œì—ëŠ” ìœ„ python main.py ì£¼ì„ì„ í•´ì œí•˜ê³  ì•„ë˜ ì¤„ì€ ì‚­ì œí•˜ì„¸ìš”.
          if [ ! -f "main.py" ]; then
            echo "âš ï¸ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì–´ í…ŒìŠ¤íŠ¸ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤."
            touch output_video_$(date +%Y%m%d).mp4
          fi

      # ----------------------------------------------------------------
      # 5. [í™œì„±í™”] ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥ (ì›¹ì—ì„œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•˜ê²Œ)
      # ----------------------------------------------------------------
      - name: ğŸ“¤ Upload Artifacts (Temporary Storage)
        uses: actions/upload-artifact@v4
        with:
          name: finished-videos
          path: |
            scripts/*.mp4
            scripts/*.mp3
            *.mp4

      # ----------------------------------------------------------------
      # 6. [ì„œë²„ ì €ì¥] ìƒì„±ëœ ì˜ìƒì„ ì €ì¥ì†Œë¡œ ìë™ ì—…ë¡œë“œ
      # ----------------------------------------------------------------
      - name: ğŸ’¾ Commit and Push Generated Videos
        run: |
          # Git ë´‡ ê³„ì • ì„¤ì •
          git config --global user.name "Video-Bot"
          git config --global user.email "bot@video-server.com"
          
          # MP4 íŒŒì¼ ê°ì§€ ë° ìŠ¤í…Œì´ì§•
          # (scripts í´ë”ì™€ ë£¨íŠ¸ ê²½ë¡œ ëª¨ë‘ í™•ì¸)
          git add scripts/*.mp4 *.mp4 2>/dev/null || true
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸ í›„ ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "âš ï¸ ìƒˆë¡œ ìƒì„±ëœ ì˜ìƒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì»¤ë°‹ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          else
            git commit -m "ğŸ¥ New Video Generated: $(date +'%Y-%m-%d %H:%M:%S') [skip ci]"
            git push
            echo "âœ… ì˜ìƒ íŒŒì¼ì´ ì €ì¥ì†Œë¡œ ì•ˆì „í•˜ê²Œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
