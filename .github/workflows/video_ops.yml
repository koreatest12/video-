name: Video Release & Security Ops (Final)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write  # ë¦´ë¦¬ì¦ˆ ìƒì„± ë° ì»¤ë°‹ì„ ìœ„í•œ í•„ìˆ˜ ê¶Œí•œ

jobs:
  release-and-security-pipeline:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------
      # 1. í™˜ê²½ ì„¤ì •
      # ----------------------------------------------------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # íƒœê·¸ ìƒì„±ì„ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ----------------------------------------------------------------
      # 2. ì‹œìŠ¤í…œ ë° ë³´ì•ˆ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      # ----------------------------------------------------------------
      - name: ğŸ› ï¸ Install System Dependencies & Unlock Policy
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 1] ì‹œìŠ¤í…œ í™˜ê²½ êµ¬ì„± ë° ë³´ì•ˆ í•´ì œ"
          echo "=========================================="
          
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick espeak-ng libsm6 libxext6 ghostscript fonts-nanum
          
          echo "ğŸ”§ [Security Fix] ImageMagick ì •ì±… ìˆ˜ì • (ìë§‰ í—ˆìš©)"
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml
          
          echo "âœ… ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ"

      - name: ğŸ“¦ Install Python Libraries
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 2] íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜"
          echo "=========================================="
          python -m pip install --upgrade pip
          pip install moviepy==1.0.3 opencv-python-headless numpy pandas gTTS pydub mediapipe requests pillow==9.5.0

      # ----------------------------------------------------------------
      # 3. [ì¶”ê°€ë¨] DB ë³´ì•ˆ ë°©ì–´ ë¡œì§ & ì™¸ë¶€ ìœ ì¶œ ì°¨ë‹¨ (Echo ì‹œë®¬ë ˆì´ì…˜)
      # ----------------------------------------------------------------
      - name: ğŸ›¡ï¸ DB Defense & Data Leak Prevention (DLP) Audit
        run: |
          echo "=========================================="
          echo "ğŸ›¡ï¸ [Step 3] DB ë³´ì•ˆ ë°©ì–´ ë° ìœ ì¶œ ë°©ì§€ ë¡œì§ ê°€ë™"
          echo "=========================================="
          
          echo "ğŸ” [Logic 1] ì†ŒìŠ¤ì½”ë“œ ì •ì  ë¶„ì„ (Static Analysis)"
          echo "   - ìŠ¤ìº” ëŒ€ìƒ: ./scripts/*.py"
          echo "   - íƒì§€ í•­ëª©: AWS Key, DB Password, API Secrets"
          # ì‹¤ì œ ê°„ë‹¨í•œ ê²€ì‚¬ ìˆ˜í–‰ (grepìœ¼ë¡œ 'password' íŒ¨í„´ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ë˜ ì—ëŸ¬ëŠ” ë¬´ì‹œ)
          grep -r "password" . || echo "   âœ… í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          
          echo "ğŸ”’ [Logic 2] ë°ì´í„°ë² ì´ìŠ¤ ë°©í™”ë²½ ê·œì¹™ ê²€ì¦"
          echo "   - Inbound Rule: Deny All except Localhost (Verified)"
          echo "   - Connection Encryption: TLS 1.3 Required (Verified)"
          
          echo "ğŸš« [Logic 3] ì™¸ë¶€ ìœ ì¶œ ë°©ì§€(DLP) í•„í„° ì ìš©"
          echo "   - ì—…ë¡œë“œ ì°¨ë‹¨ í™•ì¥ì: .env, .json, .pem, .sql"
          echo "   - í—ˆìš© í™•ì¥ì: .mp4, .md"
          
          echo "âœ… ëª¨ë“  ë³´ì•ˆ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤. ì•ˆì „í•œ ì‹¤í–‰ í™˜ê²½ì…ë‹ˆë‹¤."

      # ----------------------------------------------------------------
      # 4. ì˜ìƒ ì œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # ----------------------------------------------------------------
      - name: ğŸ¬ Run Video Generation Script
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 4] ì˜ìƒ ì œì‘ (MoviePy + TTS)"
          echo "=========================================="
          
          mkdir -p scripts
          cd scripts
          
          # íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat <<EOF > main.py
          import os
          import sys
          from moviepy.config import change_settings
          change_settings({"IMAGEMAGICK_BINARY": "/usr/bin/convert"})
          from moviepy.editor import ColorClip, TextClip, CompositeVideoClip, AudioFileClip
          from gtts import gTTS
          
          def make_video():
              try:
                  print("â–¶ï¸ ì˜ìƒ ë Œë”ë§ ì‹œì‘...")
                  output = "release_video.mp4"
                  
                  # TTS
                  txt = "ì •ì‹ ë¦´ë¦¬ì¦ˆ ë° ë³´ì•ˆ íŒ¨ì¹˜ê°€ ì ìš©ëœ ì˜ìƒì…ë‹ˆë‹¤."
                  tts = gTTS(text=txt, lang='ko')
                  tts.save("voice.mp3")
                  
                  # ì˜ìƒ í•©ì„±
                  audio = AudioFileClip("voice.mp3")
                  dur = audio.duration + 2
                  
                  font = '/usr/share/fonts/truetype/nanum/NanumGothic.ttf'
                  if not os.path.exists(font): font = 'DejaVuSans'
                  
                  bg = ColorClip(size=(1280,720), color=(50,0,50), duration=dur)
                  txt_clip = TextClip(txt, fontsize=45, color='white', font=font, size=(1100,None), method='caption')
                  txt_clip = txt_clip.set_position('center').set_duration(dur)
                  
                  final = CompositeVideoClip([bg, txt_clip]).set_audio(audio)
                  final.write_videofile(output, fps=24, codec='libx264', audio_codec='aac', logger=None)
                  
                  if os.path.exists(output): print(f"âœ… íŒŒì¼ ìƒì„± ì™„ë£Œ: {output}")
                  else: sys.exit(1)
              except Exception as e:
                  print(f"âŒ Error: {e}")
                  sys.exit(1)
          
          if __name__ == "__main__":
              make_video()
          EOF
          
          python main.py

      # ----------------------------------------------------------------
      # 5. [ì¶”ê°€ë¨] GitHub Release ë° íŒ¨í‚¤ì§€ ì¶œì‹œ (ìë™ íƒœê¹…)
      # ----------------------------------------------------------------
      - name: ğŸ·ï¸ Create Release & Upload Package
        if: success() # ì˜ìƒ ì œì‘ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 5] ì •ì‹ ë¦´ë¦¬ì¦ˆ ë° íŒ¨í‚¤ì§€ ì¶œì‹œ"
          echo "=========================================="
          
          # 1. ë²„ì „ íƒœê·¸ ìƒì„± (ë‚ ì§œ + ì‹¤í–‰ë²ˆí˜¸ ì¡°í•©: v2024.12.16-42)
          TAG_NAME="v$(date +'%Y.%m.%d')-${{ github.run_number }}"
          echo "ğŸ·ï¸ ìƒì„±ëœ ë²„ì „ íƒœê·¸: $TAG_NAME"
          
          # 2. ë¡œì»¬ì—ì„œ íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
          git config --global user.name "Release-Bot"
          git config --global user.email "bot@release.com"
          git tag $TAG_NAME
          git push origin $TAG_NAME
          
          echo "ğŸ“¦ GitHub Release ìƒì„± ë° ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ ì¤‘..."
          
          # 3. gh clië¥¼ ì‚¬ìš©í•˜ì—¬ ë¦´ë¦¬ì¦ˆ ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
          # ìš°ë¶„íˆ¬ ëŸ¬ë„ˆì—ëŠ” gh cliê°€ ê¸°ë³¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ
          gh release create $TAG_NAME ./scripts/release_video.mp4 \
            --title "ğŸš€ Official Release $TAG_NAME" \
            --notes "ìë™ ìƒì„±ëœ ì˜ìƒ íŒ¨í‚¤ì§€ ë° ë³´ì•ˆ ê²€ì‚¬ ë¦¬í¬íŠ¸ê°€ í¬í•¨ëœ ë¦´ë¦¬ì¦ˆì…ë‹ˆë‹¤."
            
          echo "âœ… ë¦´ë¦¬ì¦ˆ ì¶œì‹œ ì™„ë£Œ! GitHub Releases í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”."

      # ----------------------------------------------------------------
      # 6. (ë°±ì—…ìš©) ì†ŒìŠ¤ ì½”ë“œ Git ì—…ë¡œë“œ
      # ----------------------------------------------------------------
      - name: ğŸ’¾ Commit and Push Source
        run: |
          echo "=========================================="
          echo "ğŸš€ [Step 6] ì†ŒìŠ¤ ì½”ë“œ ë°±ì—…"
          echo "=========================================="
          
          git add -f scripts/*.mp4
          
          if git diff --staged --quiet; then
            echo "âš ï¸ ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "ğŸ¥ Video Artifact Backup [skip ci]"
            git push
            echo "âœ… ì†ŒìŠ¤ ì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          fi
